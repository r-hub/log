<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Fighting with Jenkins | The r-hub log</title><link rel="stylesheet" type="text/css" href="/log//css/normalize.css"><link rel="stylesheet" type="text/css" href="/log//css/highlight.css"><link rel="stylesheet" type="text/css" href="/log//css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/log/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/log/." class="title">The r-hub log</a><span class="subtitle"></span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/log/" class="sidebar-nav-item">Home</a><a href="/log/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Fighting with Jenkins</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-07-04</div></div></div><article><div class="container post"><h3 id="Streaming-output-from-Jenkins"><a href="#Streaming-output-from-Jenkins" class="headerlink" title="Streaming output from Jenkins"></a>Streaming output from Jenkins</h3><p>Seems like Jenkins does not drop TCP connections coming for the builder web<br>app to stream the console output. What is even worse, it keeps a thread for<br>each connection, and gets really slow already around ~20 threads. (What the hell<br>is it doing? It should be just listening on a socket….)</p>
<p>Anyway, this needs to be fixed: <a href="https://github.com/r-hub/rhub-frontend/issues/8" target="_blank" rel="external">https://github.com/r-hub/rhub-frontend/issues/8</a></p>
<h3 id="cron-app-dies-sometimes"><a href="#cron-app-dies-sometimes" class="headerlink" title="cron app dies sometimes"></a><code>cron</code> app dies sometimes</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">2016-07-04T10:45:10.973610931Z app[web.1]: &gt; rhub-cron@1.0.0 start /app</div><div class="line">2016-07-04T10:45:10.973617561Z app[web.1]: &gt; node ./bin/scheduler</div><div class="line">2016-07-04T10:45:10.973623287Z app[web.1]:</div><div class="line">2016-07-04T11:42:42.620726576Z app[web.1]: /app/index.js:33</div><div class="line">2016-07-04T11:42:42.620802676Z app[web.1]: 	jen.build.get(job.name, data.lastBuild.number, function(err, data) &#123;</div><div class="line">2016-07-04T11:42:42.620850863Z app[web.1]: 	                                      ^</div><div class="line">2016-07-04T11:42:42.620885526Z app[web.1]:</div><div class="line">2016-07-04T11:42:42.620919177Z app[web.1]: TypeError: Cannot read property &apos;number&apos; of null</div><div class="line">2016-07-04T11:42:42.620927075Z app[web.1]:     at /app/index.js:33:40</div><div class="line">2016-07-04T11:42:42.620932178Z app[web.1]:     at next (/app/node_modules/papi/lib/client.js:292:32)</div><div class="line">2016-07-04T11:42:42.620946196Z app[web.1]:     at Jenkins.body (/app/node_modules/jenkins/lib/middleware.js:14:3)</div><div class="line">2016-07-04T11:42:42.620950958Z app[web.1]:     at next (/app/node_modules/papi/lib/client.js:298:10)</div><div class="line">2016-07-04T11:42:42.620955722Z app[web.1]:     at Jenkins.&lt;anonymous&gt; (/app/node_modules/jenkins/lib/middleware.js:88:5)</div><div class="line">2016-07-04T11:42:42.620960668Z app[web.1]:     at next (/app/node_modules/papi/lib/client.js:298:10)</div><div class="line">2016-07-04T11:42:42.620965208Z app[web.1]:     at Jenkins._onResponse (/app/node_modules/jenkins/lib/jenkins.js:109:3)</div><div class="line">2016-07-04T11:42:42.620981759Z app[web.1]:     at next (/app/node_modules/papi/lib/client.js:298:10)</div><div class="line">2016-07-04T11:42:42.620988281Z app[web.1]:     at IncomingMessage.&lt;anonymous&gt; (/app/node_modules/papi/lib/client.js:598:7)</div><div class="line">2016-07-04T11:42:42.621025915Z app[web.1]:     at emitNone (events.js:85:20)</div></pre></td></tr></table></figure>
<p><a href="https://github.com/r-hub/rhub-cron/issues/1" target="_blank" rel="external">https://github.com/r-hub/rhub-cron/issues/1</a></p>
<h3 id="Upload-storage-dokku-upgrade"><a href="#Upload-storage-dokku-upgrade" class="headerlink" title="Upload storage, dokku upgrade"></a>Upload storage, dokku upgrade</h3><p>Uploads must be moved out of the container, because if I update the web app,<br>they are deleted. Dokku makes this easy with the new storage plugin<br>(<a href="http://dokku.viewdocs.io/dokku/dokku-storage/" target="_blank" rel="external">http://dokku.viewdocs.io/dokku/dokku-storage/</a>), but for this I had to upgrade<br>dokku to 0.6.4.</p>
<p>It all seems to work fine, except that every time I redeploy the frontend,<br>I usually need to redeploy the backend as well….</p>
<p>Closes <a href="https://github.com/r-hub/rhub-frontend/issues/7" target="_blank" rel="external">https://github.com/r-hub/rhub-frontend/issues/7</a></p>
<h3 id="Periodically-building-the-docker-images"><a href="#Periodically-building-the-docker-images" class="headerlink" title="Periodically building the docker images"></a>Periodically building the docker images</h3><p>For the devel R versions at least. I cannot do this on Docker Hub, because<br>I have multiple images in a single repo (I really do not want 20 repos for<br>20 images.) I also cannot do it on Travis, because with 6 images I already<br>hit the 50 minutes time limit.</p>
<p>So I’ll do it on the Jenkins CI on Azure (cran.r-hub.io). It takes about<br>2 hours to build them now. I’ll do them once a week (Sunday evening), and<br>also whenever the repo with the Dockerfiles changes. I have added a hook<br>for this. The job pushes the images to Docker Hub.</p>
<p>I still need to have a way to pull them to the worker nodes, I guess that’ll<br>be just another Jenkins job on the workers. This one can run every hour,<br>if there are no new images, then it is quick. Also, just one job is enough,<br>just need to configure it to run on all workers.</p>
<p>Apparently, I need the <code>Elastic Axis plugin</code> for this. I run the pulls<br>sequentially, so that the worker nodes don’t update at the same time.</p>
<h3 id="Use-a-single-keepalive-job"><a href="#Use-a-single-keepalive-job" class="headerlink" title="Use a single keepalive job"></a>Use a single keepalive job</h3><p>Instead of one per worker. Now that I have found the <code>Elastic Axis plugin</code>.</p>
<h3 id="Test-builder-web-app"><a href="#Test-builder-web-app" class="headerlink" title="Test builder web app"></a>Test builder web app</h3><p>Is at <a href="http://builder-test.r-hub.io" target="_blank" rel="external">http://builder-test.r-hub.io</a>. Note the <code>http</code>, letsencrypt seems<br>to be down, so I could not get a certificate. This has a different redirect<br>URL, so it needs a separate GitHub application.</p>
<h3 id="Alternative-email-address"><a href="#Alternative-email-address" class="headerlink" title="Alternative email address"></a>Alternative email address</h3><p><a href="https://github.com/r-hub/rhub-frontend/issues/9" target="_blank" rel="external">https://github.com/r-hub/rhub-frontend/issues/9</a> The test builder uses<br>this now.</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">The r-hub log</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>